<ion-header>
  <ion-toolbar>
    <ion-title>Ablaufplan erstellen</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss()">
        <ion-icon slot="icon-only" name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content color="light">
  <ion-list [inset]="true">
    <ion-list-header>
      <ion-label>Zugehörige Anwesenheit</ion-label>
      <ion-button (click)="resetPlan()" fill="clear">
        <ion-icon name="refresh"></ion-icon>
      </ion-button>
    </ion-list-header>
    <ion-item-group>
      @if (attendances.length) {
        <ion-item [lines]="attendance && notes ? '' : 'none'">
          <ion-select interface="modal" label="Aktuelle" (ionChange)="onAttChange()" [(ngModel)]="attendance">
            @for (att of attendances; track att) {
              <ion-select-option [value]="att.id">{{ att.date | date:'dd.MM.yyyy' }} {{
              getAttTypeText(att) }}</ion-select-option>
            }
          </ion-select>
        </ion-item>
      }
      @if (attendance && notes) {
        <ion-item lines="none">
          <ion-label position="stacked">Anwesenheitsnotizen</ion-label>
          <ion-textarea autoGrow="true" disabled="true">{{ notes }}</ion-textarea>
        </ion-item>
      }
      @if (attendance) {
        <ion-item lines="none">
          <ion-toggle [(ngModel)]="sharePlan" (ionChange)="toggleSharePlan()">
            <ion-label>Plan mit Mitgliedern teilen</ion-label>
          </ion-toggle>
        </ion-item>
      }
      <ion-row>
        <ion-col>
          <ion-button (click)="prevAtt()" size="small" fill="clear" expand="full">
            <ion-icon slot="start" name="arrow-back-outline"></ion-icon>
            Vorige
          </ion-button>
        </ion-col>
        <ion-col>
          <ion-button (click)="nextAtt()" size="small" fill="clear" expand="full">
            Nächste
            <ion-icon slot="end" name="arrow-forward-outline"></ion-icon>
          </ion-button>
        </ion-col>
      </ion-row>
    </ion-item-group>
  </ion-list>

  <ion-list [inset]="true">
    <ion-list-header>
      <ion-label>Ablauf</ion-label>
      <ion-button id="add-trigger" fill="clear">
        <ion-icon name="add"></ion-icon>
      </ion-button>
      <ion-popover #addPopover trigger="add-trigger" triggerAction="click">
        <ng-template>
          <ion-item (click)="addExtraField(addPopover)">
            <ion-label>Feld hinzufügen</ion-label>
          </ion-item>
          <ion-item (click)="addNoteField(addPopover)">
            <ion-label>Notizfeld hinzufügen</ion-label>
          </ion-item>
          <ion-item (click)="addCurrentSongs(addPopover)">
            <ion-label>Aktuelle Werke hinzufügen</ion-label>
          </ion-item>
          @if (songs.length) {
            <ion-item lines="none">
              <ion-select [interfaceOptions]="customModalOptions" interface="modal" label="Werk hinzufügen"
                multiple="false" (ionDismiss)="onAddSong($event.target.value, addPopover)">
                @for (song of songs; track song) {
                  <ion-select-option [value]="song.id.toString()">{{ song.prefix }}{{ song.number }} {{ song.name }}</ion-select-option>
                }
              </ion-select>
            </ion-item>
          }
        </ng-template>
      </ion-popover>
    </ion-list-header>

    <ion-item-group>
      <ion-item>
        <ion-label>Start</ion-label>
        <ion-datetime-button datetime="datetime"></ion-datetime-button>
        <ion-modal [keepContentsMounted]="true">
          <ng-template>
            <ion-datetime (ionChange)="calculateEnd()" locale="de-DE" [(ngModel)]="time" presentation="time" id="datetime"
              [formatOptions]="{
                      time: {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                      }
                    }"></ion-datetime>
        </ng-template>
      </ion-modal>
    </ion-item>

    <ion-list>
      <ion-reorder-group disabled="false" (ionItemReorder)="handleReorder($any($event))">
        @for (field of selectedFields; track trackByFieldId(i, field); let i = $index) {
          <ion-item-sliding #slider>
            <ion-item>
              <ion-label (click)="changeField(field)">
                <h2>{{ field.name }}</h2>
                @if (field.songId) {
                  <h3 class="danger">{{ getMissingGroups(field.songId) }}</h3>
                }
                @if (!field.id.includes('noteFld')) {
                  <h3>{{ calculateTime(field, i) }}</h3>
                }
              </ion-label>
              @if (!field.id.includes('noteFld')) {
                <ion-input required="true" style="width: 3rem;" (ionBlur)="calculateEnd()" [(ngModel)]="field.time"
                placeholder="min" type="number" slot="end"></ion-input>
              }
              <ion-reorder slot="end"></ion-reorder>
            </ion-item>
            <ion-item-options (ionSwipe)="removeField(i, slider)">
              <ion-item-option expandable color="danger" (click)="removeField(i, slider)">
                <ion-icon name="trash"></ion-icon>
              </ion-item-option>
            </ion-item-options>
          </ion-item-sliding>
        }
      </ion-reorder-group>
    </ion-list>

    @if (end) {
      <ion-item class="marginBottom">
        <ion-label>Ende</ion-label>
        <ion-datetime-button datetime="datetimeend"></ion-datetime-button>
        <ion-modal [keepContentsMounted]="true">
          <ng-template>
            <ion-datetime locale="de-DE" disabled="true" [(ngModel)]="end" presentation="time" id="datetimeend" [formatOptions]="{
                      time: {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                      }
                    }">
          </ion-datetime>
        </ng-template>
      </ion-modal>
    </ion-item>
  }
</ion-item-group>
</ion-list>

<ion-modal [isOpen]="isPlanModalOpen" #planModal trigger="trigger-button" [breakpoints]="[0, 0.5]"
  [initialBreakpoint]="0.5">
  <ng-template>
    <ion-content>
      <ion-header>
        <ion-toolbar>
          <ion-title>Plan erstellen</ion-title>
        </ion-toolbar>
      </ion-header>
      <ion-item>
        <ion-select label="Dirigenten" [(ngModel)]="selConductors" #select multiple="true">
          @for (con of conductors; track con) {
            <ion-select-option [value]="con.id">{{ con.firstName }} {{ con.lastName
            }}</ion-select-option>
          }
        </ion-select>
      </ion-item>
      <ion-item>
        <ion-label position="stacked">Zeit in Minuten</ion-label>
        <ion-input value="60" #input type="number"></ion-input>
      </ion-item>
      <ion-button [disabled]="!select.value?.length || !input.value"
      (click)="createPlan(select.value, input.value, planModal)" expand="block">Exportieren</ion-button>
      @if (db.tenantUser().telegram_chat_id) {
        <ion-button [disabled]="!select.value?.length || !input.value"
          (click)="createPlan(select.value, input.value, planModal, true, false)" expand="block">Per Telegram (PDF)
        </ion-button>
        <ion-button [disabled]="!select.value?.length || !input.value"
          (click)="createPlan(select.value, input.value, planModal, true, true)" expand="block">Per Telegram (Bild)
        </ion-button>
      }
    </ion-content>
  </ng-template>
</ion-modal>

<ion-fab horizontal="end" vertical="bottom" slot="fixed">
  <ion-fab-button (click)="showOptions()">
    <ion-icon name="ellipsis-horizontal"></ion-icon>
  </ion-fab-button>
</ion-fab>
</ion-content>
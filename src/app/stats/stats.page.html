<ion-header>
  <ion-toolbar color="light">
    <ion-title>Statistiken</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss()">
        <ion-icon slot="icon-only" name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content color="light">

  <!-- ==================== ZEITRAUM ==================== -->
  <ion-list [inset]="true">
    <ion-list-header>
      ğŸ“… Zeitraum
    </ion-list-header>
    <ion-item>
      <ion-input
        type="date"
        label="Von"
        labelPlacement="stacked"
        [(ngModel)]="filterStartDate"
        (ionChange)="onDateFilterChange()">
      </ion-input>
    </ion-item>
    <ion-item lines="none">
      <ion-input
        type="date"
        label="Bis"
        labelPlacement="stacked"
        [(ngModel)]="filterEndDate"
        (ionChange)="onDateFilterChange()">
      </ion-input>
    </ion-item>
  </ion-list>

  <!-- ==================== ANWESENHEITS-ÃœBERSICHT ==================== -->
  <ion-list [inset]="true">
    <ion-list-header>
      ğŸ“Š Anwesenheits-Ãœbersicht
    </ion-list-header>

    <ion-item>
      <ion-label>Termine im Zeitraum</ion-label>
      <ion-badge slot="end">{{ attendances?.length }}</ion-badge>
    </ion-item>

    @for(type of this.db.attendanceTypes(); track type.id) {
      @if (getAttTypeLength(type.id) > 0) {
        <ion-item>
          <ion-label class="ion-text-wrap">{{ type.name }}</ion-label>
          <ion-badge slot="end">{{ getAttTypeLength(type.id) }}</ion-badge>
        </ion-item>
      }
    }

    <ion-item>
      <ion-label>Ã˜ Anwesenheit</ion-label>
      <ion-badge slot="end" [color]="attPerc >= 70 ? 'success' : attPerc >= 50 ? 'warning' : 'danger'">
        {{ attPerc }}%
      </ion-badge>
    </ion-item>

    @if (bestAttendance) {
      <ion-item>
        <ion-label>
          <p>Beste Anwesenheit</p>
          <h2>{{ bestAttendance.date | date:'dd.MM.yyyy' }}</h2>
        </ion-label>
        <ion-badge slot="end" color="success">{{ bestAttendance.percentage }}%</ion-badge>
      </ion-item>
    }

    @if (worstAttendance) {
      <ion-item lines="none">
        <ion-label>
          <p>Schlechteste Anwesenheit</p>
          <h2>{{ worstAttendance.date | date:'dd.MM.yyyy' }}</h2>
        </ion-label>
        <ion-badge slot="end" color="danger">{{ worstAttendance.percentage }}%</ion-badge>
      </ion-item>
    }
  </ion-list>

  <!-- ==================== ANWESENHEITS-CHARTS ==================== -->
  @if (chartsReady) {
    <ion-list [inset]="true">
      <ion-list-header>
        ğŸ“ˆ Anwesenheits-Trend
      </ion-list-header>

      <!-- Attendance Trend Line Chart -->
      <ion-item lines="none">
        <div class="chart-container chart-line">
          <canvas baseChart
            [data]="attendanceTrendData"
            [options]="attendanceTrendOptions"
            type="line">
          </canvas>
        </div>
      </ion-item>
    </ion-list>

    <ion-list [inset]="true">
      <ion-list-header>
        ğŸ“‰ Statusverteilung
      </ion-list-header>

      <!-- Status Pie Chart -->
      <ion-item lines="none">
        <div class="chart-container chart-pie">
          <canvas baseChart
            [data]="statusPieData"
            [options]="statusPieOptions"
            type="pie">
          </canvas>
        </div>
      </ion-item>
    </ion-list>

    <ion-list [inset]="true">
      <ion-list-header>
        ğŸ† Top 20 Anwesenheit
      </ion-list-header>

      <!-- Top 20 Chart -->
      <ion-item lines="none">
        <div class="chart-container" [style.height.px]="top20ChartHeight">
          <canvas baseChart
            [data]="top20Data"
            [options]="top20Options"
            type="bar">
          </canvas>
        </div>
      </ion-item>
    </ion-list>

    <ion-list [inset]="true">
      <ion-list-header>
        ğŸ» Anwesenheit pro Instrument
      </ion-list-header>

      <!-- Instrument Bar Chart -->
      <ion-item lines="none">
        <div class="chart-container" [style.height.px]="instrumentChartHeight">
          <canvas baseChart
            [data]="instrumentBarData"
            [options]="instrumentBarOptions"
            type="bar">
          </canvas>
        </div>
      </ion-item>
    </ion-list>

    <ion-list [inset]="true">
      <ion-list-header>
        âš ï¸ Unentschuldigte Abwesenheiten
      </ion-list-header>

      <!-- Unexcused Absences Chart -->
      <ion-item lines="none">
        <div class="chart-container" [style.height.px]="divaChartHeight">
          <canvas baseChart
            [data]="divaIndexData"
            [options]="divaIndexOptions"
            type="bar">
          </canvas>
        </div>
      </ion-item>
    </ion-list>
  }

  <!-- ==================== PERSONEN ==================== -->
  <ion-list [inset]="true">
    <ion-list-header>
      ğŸ‘¥ Mitglieder
    </ion-list-header>

    <ion-item>
      <ion-label>Aktive Mitglieder</ion-label>
      <ion-badge slot="end" color="success">{{ activePlayers?.length }}</ion-badge>
    </ion-item>

    <ion-item>
      <ion-label>Pausierend</ion-label>
      <ion-badge slot="end" color="warning">{{ pausedPlayers?.length }}</ion-badge>
    </ion-item>

    <ion-item>
      <ion-label>Ausgetreten</ion-label>
      <ion-badge slot="end" color="medium">{{ leftPlayers?.length }}</ion-badge>
    </ion-item>

    <ion-item lines="none">
      <ion-label><strong>Gesamt</strong></ion-label>
      <ion-badge slot="end">{{ players?.length }}</ion-badge>
    </ion-item>
  </ion-list>

  <!-- ==================== DEMOGRAFIE ==================== -->
  @if (chartsReady) {
    <ion-list [inset]="true">
      <ion-list-header>
        ğŸ‚ Altersverteilung
      </ion-list-header>

      <!-- Age Distribution Chart -->
      <ion-item lines="none">
        <div class="chart-container">
          <canvas baseChart
            [data]="ageDistributionData"
            [options]="ageDistributionOptions"
            type="bar">
          </canvas>
        </div>
      </ion-item>
    </ion-list>

    <ion-list [inset]="true">
      <ion-list-header>
        ğŸ“Š Durchschnittsalter pro Instrument
      </ion-list-header>

      <!-- Average Age per Instrument Chart -->
      <ion-item lines="none">
        <div class="chart-container" [style.height.px]="avgAgeChartHeight">
          <canvas baseChart
            [data]="avgAgePerInstrumentData"
            [options]="avgAgePerInstrumentOptions"
            type="bar">
          </canvas>
        </div>
      </ion-item>
    </ion-list>
  }

  <!-- ==================== ORGANISATION ==================== -->
  @if (db.organisation()) {
    <ion-list [inset]="true">
      <ion-list-header>
        ğŸ¢ {{ db.organisation().name }}
      </ion-list-header>

      <ion-item>
        <ion-select
          (ionDismiss)="filterInstances()"
          label="Instanzen filtern"
          [(ngModel)]="selectedInstances"
          interface="modal"
          multiple="true">
          @for(tenant of tenants; track tenant.id) {
            <ion-select-option [value]="tenant.id">{{ tenant.longName }}</ion-select-option>
          }
        </ion-select>
      </ion-item>

      <ion-item button detail="false" (click)="openInstancesAlert()">
        <ion-label>Instanzen</ion-label>
        @if (selectedInstances.length === 0) {
          <ion-badge slot="end">Alle ({{ tenants.length }})</ion-badge>
        } @else {
          <ion-badge slot="end">{{ selectedInstances.length }}</ion-badge>
        }
      </ion-item>

      <ion-item button detail="false" lines="none" id="persons-button">
        <ion-label>Personen Ã¼ber alle Instanzen</ion-label>
        <ion-badge slot="end">{{ uniquePersons.length }}</ion-badge>

        <ion-modal trigger="persons-button" [breakpoints]="[0, 1]" [initialBreakpoint]="1">
          <ng-template>
            <ion-content color="light">
              <ion-header>
                <ion-toolbar>
                  <ion-title>Personen ({{ uniquePersons.length }})</ion-title>
                </ion-toolbar>
              </ion-header>

              <ion-list [inset]="true">
                @for (u of uniquePersons; track trackByPersonId($index, u)) {
                  <ion-item>
                    <ion-label>
                      <h2>{{ u.firstName }} {{ u.lastName }}</h2>
                      @for (tenant of u.tenants; track tenant.id) {
                        <p>{{ tenant.longName }}</p>
                      }
                    </ion-label>
                    <ion-badge slot="end">{{ u.tenants.length }}</ion-badge>
                  </ion-item>
                }
              </ion-list>
            </ion-content>
          </ng-template>
        </ion-modal>
      </ion-item>
    </ion-list>
  }

</ion-content>

<ion-header>
  <ion-toolbar color="light">
    <ion-title>Neue Instanz anlegen</ion-title>
    @if (canDismiss) {
    <ion-buttons slot="end">
      <ion-button (click)="close()">
        <ion-icon slot="icon-only" name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
    }
  </ion-toolbar>
</ion-header>

<ion-content color="light" [fullscreen]="true">
  <!-- Intro Card -->
  <ion-card>
    <ion-card-header>
      <ion-icon class="headerIcon" name="rocket-outline"></ion-icon>
      <ion-card-title>Willkommen!</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <p>Eine <strong>Instanz</strong> ist dein eigener Bereich für dein Orchester, deinen Chor oder deine Gruppe. Hier
        verwaltest du Mitglieder, Termine und Anwesenheiten.</p>
    </ion-card-content>
  </ion-card>

  <ion-card class="hint-card">
    <ion-card-content>
      <div class="hint-content">
        <div>
          <strong>Du möchtest einer bestehenden Instanz beitreten?</strong>
          <p>Bitte deinen Verantwortlichen, dich per E-Mail einzuladen. Eine neue Instanz ist nur nötig, wenn du selbst
            Administrator sein möchtest.</p>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Step 1: Type -->
  <ion-list [inset]="true">
    <ion-list-header>
      <ion-label>
        <span class="step-badge">1</span>
        Art der Gruppe wählen
      </ion-label>
    </ion-list-header>
    <ion-item-group>
      <ion-item>
        <ion-select label="Gruppentyp" labelPlacement="stacked" (ionChange)="onTypeChange()" [(ngModel)]="tenant.type"
          interface="action-sheet" [interfaceOptions]="{header: 'Was beschreibt deine Gruppe am besten?'}">
          <ion-select-option value="general">
            <ion-icon name="people-outline"></ion-icon>
            Allgemeine Gruppe
          </ion-select-option>
          <ion-select-option value="choir">Chor / Gesangsgruppe</ion-select-option>
          <ion-select-option value="orchestra">Orchester / Musikverein</ion-select-option>
        </ion-select>
      </ion-item>
    </ion-item-group>
    <p class="helper-text">
      @switch (tenant.type) {
      @case ('general') {
      <ion-icon name="checkmark-circle" color="success"></ion-icon>
      Ideal für Vereine, Teams oder sonstige Gruppen.
      }
      @case ('choir') {
      <ion-icon name="checkmark-circle" color="success"></ion-icon>
      Optimiert für Chöre mit Stimmgruppen (Sopran, Alt, Tenor, Bass).
      }
      @case ('orchestra') {
      <ion-icon name="checkmark-circle" color="success"></ion-icon>
      Optimiert für Orchester mit Instrumentengruppen.
      }
      }
    </p>
  </ion-list>

  <!-- Step 2: Name -->
  <ion-list [inset]="true">
    <ion-list-header>
      <ion-label>
        <span class="step-badge">2</span>
        Name deiner Instanz
      </ion-label>
    </ion-list-header>
    <ion-item-group>
      <ion-item>
        <ion-input label="Vollständiger Name" labelPlacement="stacked" [placeholder]="namePlaceholder"
          [(ngModel)]="tenant.longName" [counter]="true" maxlength="50"
          helperText="Der Name wird in der App angezeigt"></ion-input>
      </ion-item>
      <ion-item>
        <ion-input label="Kürzel (2-5 Zeichen)" labelPlacement="stacked" [placeholder]="shortNamePlaceholder"
          [(ngModel)]="tenant.shortName" [counter]="true" maxlength="5"
          helperText="Wird für kompakte Darstellungen verwendet"></ion-input>
      </ion-item>
    </ion-item-group>
  </ion-list>

  <!-- Step 3: Main Group -->
  <ion-list [inset]="true">
    <ion-list-header>
      <ion-label>
        <span class="step-badge">3</span>
        Hauptgruppe festlegen
      </ion-label>
      <ion-button fill="clear" size="small" id="main-group-info">
        <ion-icon slot="icon-only" name="help-circle-outline"></ion-icon>
      </ion-button>
      <ion-popover trigger="main-group-info" triggerAction="click">
        <ng-template>
          <ion-content class="ion-padding">
            <h3>Was ist die Hauptgruppe?</h3>
            <p>Die Hauptgruppe ist eine besondere Gruppe für Personen mit Leitungsfunktion (z.B. Dirigenten, Chorleiter,
              Vorstand).</p>
            <p><strong>Besonderheiten:</strong></p>
            <ul>
              <li>Kann nicht gelöscht werden</li>
              <li>Mitglieder erhalten automatisch erweiterte Rechte</li>
              <li>Ideal für Personen, die die Instanz verwalten</li>
            </ul>
            <p><em>Du kannst später weitere Gruppen (z.B. Sopran, Geigen) hinzufügen.</em></p>
          </ion-content>
        </ng-template>
      </ion-popover>
    </ion-list-header>
    <ion-item-group>
      <ion-item>
        <ion-input label="Name der Hauptgruppe" labelPlacement="stacked" [placeholder]="mainGroupPlaceholder"
          [(ngModel)]="mainGroupName" helperText="z.B. Leitung, Dirigenten, Vorstand"></ion-input>
      </ion-item>
    </ion-item-group>
  </ion-list>

  <!-- Summary & Create Button -->
  <ion-list [inset]="true">
    <ion-list-header>
      <ion-label>
        <span class="step-badge">✓</span>
        Zusammenfassung
      </ion-label>
    </ion-list-header>
    <ion-item-group>
      @if (tenant.longName && tenant.shortName && mainGroupName) {
      <ion-item lines="none">
        <ion-label class="summary">
          <p><strong>{{ tenant.longName }}</strong> ({{ tenant.shortName }})</p>
          <p>Typ: {{ getTypeLabel() }}</p>
          <p>Hauptgruppe: {{ mainGroupName }}</p>
        </ion-label>
      </ion-item>
      } @else {
      <ion-item lines="none">
        <ion-label color="medium" class="summary">
          <p><ion-icon name="alert-circle-outline"></ion-icon> Bitte fülle alle Felder aus, um fortzufahren.</p>
          <ul class="missing-fields">
            @if (!tenant.longName) {
            <li>Name der Instanz fehlt</li>
            }
            @if (!tenant.shortName) {
            <li>Kürzel fehlt</li>
            }
            @if (!mainGroupName) {
            <li>Name der Hauptgruppe fehlt</li>
            }
          </ul>
        </ion-label>
      </ion-item>
      }
    </ion-item-group>
  </ion-list>

  @if (tenant.longName && tenant.shortName && mainGroupName) {
  <ion-button expand="block" class="ion-margin" (click)="createInstance()">
    <ion-icon slot="start" name="add-circle-outline"></ion-icon>
    Instanz jetzt erstellen
  </ion-button>
  } @else {
  <ion-button expand="block" class="ion-margin" disabled>
    <ion-icon slot="start" name="add-circle-outline"></ion-icon>
    Instanz jetzt erstellen
  </ion-button>
  }

  <div class="spacer"></div>
</ion-content>
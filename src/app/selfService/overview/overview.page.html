<ion-header translucent="true">
  <ion-toolbar>
    <ion-title>Alle Termine</ion-title>
    <ion-buttons slot="end">
      <ion-button id="legend-button-overview">
        <ion-icon slot="icon-only" name="information-outline"></ion-icon>
      </ion-button>
      <ion-modal [breakpoints]="[0, 0.5, 1]" [initialBreakpoint]="0.5" trigger="legend-button-overview">
        <ng-template>
          <ion-content color="light">
            <ion-list [inset]="true">
              <ion-list-header>
                <ion-label>Legende</ion-label>
              </ion-list-header>
              <ion-item-group>
                <ion-item lines="none">
                  <ion-badge slot="start" color="success">✓</ion-badge>
                  <ion-label>Anwesend</ion-label>
                </ion-item>
                <ion-item lines="none">
                  <ion-badge slot="start" color="warning">E</ion-badge>
                  <ion-label>Entschuldigt</ion-label>
                </ion-item>
                <ion-item lines="none">
                  <ion-badge slot="start" color="danger">A</ion-badge>
                  <ion-label>Abwesend</ion-label>
                </ion-item>
                <ion-item lines="none">
                  <ion-badge slot="start" color="tertiary">L</ion-badge>
                  <ion-label>Verspätet anwesend</ion-label>
                </ion-item>
                <ion-item lines="none">
                  <ion-badge slot="start" color="rosa">LE</ion-badge>
                  <ion-label>Verspätet entschuldigt</ion-label>
                </ion-item>
                <ion-item lines="none">
                  <ion-badge slot="start" color="medium">N</ion-badge>
                  <ion-label>Neutral</ion-label>
                </ion-item>
              </ion-item-group>
            </ion-list>
          </ion-content>
        </ng-template>
      </ion-modal>
    </ion-buttons>
  </ion-toolbar>
  <ion-toolbar>
    <ion-segment [value]="groupingMode" (ionChange)="onGroupingChange($event)">
      <ion-segment-button value="chronological">
        <ion-label>Chronologisch</ion-label>
      </ion-segment-button>
      <ion-segment-button value="byTenant">
        <ion-label>Nach Instanz</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content fullscreen="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Alle Termine</ion-title>
    </ion-toolbar>
  </ion-header>

  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Loading State -->
  @if (db.crossTenantAttendancesLoading()) {
    <ion-card>
      <ion-card-content class="ion-text-center">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Termine werden geladen...</p>
      </ion-card-content>
    </ion-card>
  }

  <!-- Statistics Card -->
  @if (!db.crossTenantAttendancesLoading() && pastAttendances.length > 0) {
    <ion-card>
      <ion-card-content>
        <h1 class="title">Gesamtübersicht</h1>
        Du warst bisher an <ion-label [color]="perc >= 75 ? 'success' : perc >= 50 ? 'warning' : 'danger'">{{ perc }}%</ion-label> der Termine anwesend.
        @if (lateCount && lateCount !== 0) {
          <br>
            Davon bist du <ion-label color="tertiary">{{ lateCount }}x</ion-label> unentschuldigt zu spät gekommen.
          }
        </ion-card-content>
      </ion-card>
    }

    <!-- Excuse Modal -->
    <ion-modal #excuseModal initialBreakpoint="0.8" [breakpoints]="[0, 0.8]">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-buttons slot="start">
              <ion-button (click)="dismissExcuseModal()">Abbrechen</ion-button>
            </ion-buttons>
            <ion-title>{{ isLateComingEvent ? 'Verspätung' : 'Abmeldung' }}</ion-title>
            <ion-buttons slot="end">
              <ion-button [disabled]="isReasonSelectionInvalid(reason)" (click)="signout()">Bestätigen</ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding">
          <ion-list>
            <div>
              <ion-list>
                <ion-item class="margin-auto">
                  <ion-select [(ngModel)]="reasonSelection" (ionChange)="onReasonSelect($event)" class="margin-auto"
                    aria-label="reason-ion-select" interface="action-sheet" placeholder="Grund auswählen">
                    <ion-select-option value="Krankheitsbedingt">Krankheitsbedingt</ion-select-option>
                    <ion-select-option value="Urlaubsbedingt">Urlaubsbedingt</ion-select-option>
                    <ion-select-option value="Arbeitsbedingt">Arbeitsbedingt</ion-select-option>
                    <ion-select-option value="Familienbedingt">Familienbedingt</ion-select-option>
                    <ion-select-option value="Sonstiger Grund">Sonstiger Grund (Text)</ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-list>
            </div>
            @if (selAttIds.length && reasonSelection === 'Sonstiger Grund') {
              <ion-item>
                <ion-label position="stacked">Grund</ion-label>
                <ion-textarea placeholder="Mindestens 5 Zeichen eingeben..." [(ngModel)]="reason"
                (ionFocus)="increaseModalBreakpoint()" (ionBlur)="decreaseModalBreakpoint()"></ion-textarea>
              </ion-item>
            }
          </ion-list>
        </ion-content>
      </ng-template>
    </ion-modal>

    <!-- Chronological View -->
    @if (groupingMode === 'chronological' && !db.crossTenantAttendancesLoading()) {
      <ion-accordion-group [multiple]="true" [value]="['current', 'upcoming']">
        <!-- Current Attendance -->
        @if (currentAttendance) {
          <ion-accordion value="current">
            <ion-item slot="header" color="primary">
              <ion-label>Aktuelle</ion-label>
            </ion-item>
            <div slot="content">
              <ion-list>
                <ion-item button (click)="presentActionSheetForChoice(currentAttendance)" color="light">
                  <div class="tenant-indicator" [style.backgroundColor]="currentAttendance.tenantColor" slot="start"></div>
                  <ion-label>
                    <h2>{{ getReadableDate(currentAttendance.date, currentAttendance.attendanceType) }}</h2>
                    <h3 [style.fontWeight]="currentAttendance.highlight ? 'bold' : 'normal'">{{ currentAttendance.title }}</h3>
                    <p class="tenant-name">{{ currentAttendance.tenantName }}</p>
                    @if (showDeadlineInfo(currentAttendance)) {
                      <ion-note [style.fontSize]="'.9rem'" color="danger">{{ getDeadlineText(currentAttendance) }}</ion-note>
                    }
                    @if (currentAttendance.notes) {
                      <ion-note [style.fontSize]="'.8rem'" color="medium">Notiz: {{ currentAttendance.notes }}</ion-note>
                    }
                  </ion-label>
                  <ion-badge slot="end" [color]="getBadgeColor(currentAttendance)">
                    {{ getBadgeText(currentAttendance) }}
                  </ion-badge>
                </ion-item>
              </ion-list>
            </div>
          </ion-accordion>
        }

        <!-- Upcoming Attendances -->
        <ion-accordion value="upcoming">
          <ion-item slot="header" color="primary">
            <ion-label>Anstehende</ion-label>
          </ion-item>
          <div slot="content">
            <ion-list>
              @for (att of upcomingAttendances; track att.id) {
                <ion-item button (click)="presentActionSheetForChoice(att)">
                  <div class="tenant-indicator" [style.backgroundColor]="att.tenantColor" slot="start"></div>
                  <ion-label>
                    <h2>{{ getReadableDate(att.date, att.attendanceType) }}</h2>
                    <h3 [style.fontWeight]="att.highlight ? 'bold' : 'normal'">{{ att.title }}</h3>
                    <p class="tenant-name">{{ att.tenantName }}</p>
                    @if (showDeadlineInfo(att)) {
                      <ion-note [style.fontSize]="'.9rem'" color="danger">{{ getDeadlineText(att) }}</ion-note>
                    }
                    @if (att.notes) {
                      <ion-note [style.fontSize]="'.8rem'" color="medium">Notiz: {{ att.notes }}</ion-note>
                    }
                  </ion-label>
                  <ion-badge slot="end" [color]="getBadgeColor(att)">
                    {{ getBadgeText(att) }}
                  </ion-badge>
                </ion-item>
              }
              @if (upcomingAttendances.length === 0) {
                <ion-item>
                  <ion-label class="ion-text-center" color="medium">
                    Keine anstehenden Termine
                  </ion-label>
                </ion-item>
              }
            </ion-list>
          </div>
        </ion-accordion>

        <!-- Past Attendances -->
        <ion-accordion value="past">
          <ion-item slot="header" color="primary">
            <ion-label>Vergangene</ion-label>
          </ion-item>
          <div slot="content">
            <ion-list>
              @if (pastAttendances.length > 0) {
                <ion-item-divider>
                  @if (lateCount === 0) {
                    <ion-label>Durchschnitt</ion-label>
                  }
                  @if (lateCount !== 0) {
                    <ion-label>Durchschnitt ({{ lateCount }}x zu spät)</ion-label>
                  }
                  <ion-badge [color]="perc >= 75 ? 'success' : perc >= 50 ? 'warning' : 'danger'" slot="end">Ø {{ perc }}%</ion-badge>
                </ion-item-divider>
              }
              @for (att of pastAttendances; track att.id) {
                <ion-item>
                  <div class="tenant-indicator" [style.backgroundColor]="att.tenantColor" slot="start"></div>
                  <ion-label>
                    <h2>{{ getReadableDate(att.date, att.attendanceType) }}</h2>
                    <h3 [style.fontWeight]="att.highlight ? 'bold' : 'normal'">{{ att.title }}</h3>
                    <p class="tenant-name">{{ att.tenantName }}</p>
                  </ion-label>
                  <ion-badge slot="end" [color]="getBadgeColor(att)">
                    {{ getBadgeText(att) }}
                  </ion-badge>
                </ion-item>
              }
              @if (pastAttendances.length === 0) {
                <ion-item>
                  <ion-label class="ion-text-center" color="medium">
                    Keine vergangenen Termine
                  </ion-label>
                </ion-item>
              }
            </ion-list>
          </div>
        </ion-accordion>
      </ion-accordion-group>
    }

    <!-- By Tenant View -->
    @if (groupingMode === 'byTenant' && !db.crossTenantAttendancesLoading()) {
      <ion-accordion-group [multiple]="true" [value]="tenantGroupValues">
        @for (group of tenantGroups; track group.tenantId; let i = $index) {
          <ion-accordion [value]="'tenant-' + i">
            <ion-item slot="header" [style.borderLeft]="'4px solid ' + group.tenantColor">
              <ion-label>{{ group.tenantName }}</ion-label>
              <ion-badge slot="end" color="medium">{{ group.attendances.length }}</ion-badge>
            </ion-item>
            <div slot="content">
              <ion-list>
                @for (att of group.attendances; track att.id) {
                  <ion-item [button]="!attHasPassed(att)" (click)="!attHasPassed(att) && presentActionSheetForChoice(att)"
                    [color]="!attHasPassed(att) ? '' : ''">
                    <ion-label>
                      <h2>{{ getReadableDate(att.date, att.attendanceType) }}</h2>
                      <h3 [style.fontWeight]="att.highlight ? 'bold' : 'normal'">{{ att.title }}</h3>
                      @if (showDeadlineInfo(att)) {
                        <ion-note [style.fontSize]="'.9rem'" color="danger">{{ getDeadlineText(att) }}</ion-note>
                      }
                      @if (att.notes) {
                        <ion-note [style.fontSize]="'.8rem'" color="medium">Notiz: {{ att.notes }}</ion-note>
                      }
                    </ion-label>
                    <ion-badge slot="end" [color]="getBadgeColor(att)">
                      {{ getBadgeText(att) }}
                    </ion-badge>
                  </ion-item>
                }
              </ion-list>
            </div>
          </ion-accordion>
        }
        @if (tenantGroups.length === 0) {
          <ion-card>
            <ion-card-content class="ion-text-center">
              <p>Keine Termine gefunden</p>
            </ion-card-content>
          </ion-card>
        }
      </ion-accordion-group>
    }
  </ion-content>
